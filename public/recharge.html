<!DOCTYPE html>
<html>
<head>
<title>Recharge Credits</title>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<style>
body{background:#0B0F19;color:white;font-family:Arial;text-align:center;padding:40px}
input{padding:10px;font-size:16px;border-radius:6px;margin:10px auto;display:block}
.btn{background:#FF8C32;padding:12px 24px;border:none;border-radius:8px;font-size:18px;cursor:pointer;color:#0B0F19}
.history{margin-top:40px;text-align:left;max-width:600px;margin-left:auto;margin-right:auto}
.history h2{color:#FF8C32;margin-bottom:20px;text-align:center}
.card{background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:15px;margin:10px 0}
.card p{margin:5px 0;font-size:14px}
.credits{color:#FF8C32;font-weight:bold}
.amount{color:#4ADE80}
.id{color:#A0A4B8;font-size:12px}
.date{color:#A0A4B8;font-size:12px}
@media(max-width:768px){.history{max-width:90%}}
</style>
</head>
<body>
<h1>{{ business.name }}</h1>
<p>Credits Left: {{ business.credit_balance }}</p>
<p>Price/Credit: ₹{{ business.price_per_credit }}</p>
<input type="number" id="credits" placeholder="Enter credits">
<button class="btn" onclick="payNow()">Recharge</button>

<div class="history">
<h2>Recharge History</h2>
<div id="history"></div>
</div>

<script>
function payNow(){
 let credits = document.getElementById("credits").value;
 if (!credits) return alert("Enter credits");

 // Store credits for verification
 window.paymentCredits = parseInt(credits);

 fetch("/api/payment/create-order", {
   method:"POST",
   headers: {"Content-Type":"application/json"},
   body:JSON.stringify({slug:"{{ slug }}", credits:parseInt(credits)})
 })
 .then(res=>res.json())
 .then(data=>{
   const options = {
     "key": data.key,
     "amount": data.amount,
     "order_id": data.order_id,
     "handler": function(response) {
       // Verify payment on our server
       fetch("/api/payment/verify", {
         method: "POST",
         headers: {"Content-Type": "application/json"},
         body: JSON.stringify({
           payment_id: response.razorpay_payment_id,
           order_id: response.razorpay_order_id,
           signature: response.razorpay_signature,
           slug: "{{ slug }}",
           credits: window.paymentCredits
         })
       })
       .then(res => res.json())
       .then(data => {
         if (data.success) {
           alert("Payment successful! Credits added to your account.");
           location.reload();
         } else {
           alert("Payment verification failed. Please contact support.");
         }
       })
       .catch(error => {
         alert("Payment verification failed. Please contact support.");
         console.error("Verification error:", error);
       });
     },
     "modal": {
       "ondismiss": function() {
         alert("Payment cancelled");
       }
     }
   };
   new Razorpay(options).open();
 });
}

function loadHistory(){
 fetch("/api/businesses/{{ slug }}/payments")
 .then(res=>res.json())
 .then(data=>{
   const historyDiv = document.getElementById("history");
   if(data.length === 0){
     historyDiv.innerHTML = "<p style='text-align:center;color:#A0A4B8'>No payment history found</p>";
     return;
   }
   historyDiv.innerHTML = data.map(payment => {
     // Format timestamp to readable format
     const timestamp = new Date(payment.timestamp);
     const formattedDate = timestamp.toLocaleDateString('en-IN', {
       year: 'numeric',
       month: 'short',
       day: 'numeric',
       hour: '2-digit',
       minute: '2-digit'
     });

     return `
     <div class="card">
       <p><span class="credits">${payment.credits} Credits</span> - <span class="amount">₹${payment.amount}</span></p>
       <p class="id">Payment ID: ${payment.razorpay_payment_id}</p>
       <p class="date">${formattedDate}</p>
       <p style="font-size:12px;color:#A0A4B8;margin-top:5px;">₹${payment.unit_price} per credit</p>
     </div>
   `}).join("");
 });
}

window.onload = loadHistory;
</script>
</body>
</html>
